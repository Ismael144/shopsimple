services: 
  products_db: 
    image: postgres:17-alpine
    container_name: products-db 
    environment:
      POSTGRES_USER: products_db_user 
      POSTGRES_PASSWORD: products_db_password
      POSTGRES_DB: productssvc
    ports: 
      - "5432:5432"
    volumes: 
      - pgdata:/var/lib/postgresql/data

  jaeger: 
    image: jaegertracing/all-in-one:1.54
    ports: 
      - "16686:16686"
      - "14268:14268"

  prometheus: 
    image: prom/prometheus
    ports: 
      - "9091:9090"
    volumes: 
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  productservice: 
    build: 
      context: ./src/productservice
      cache_from: 
        - type=local,src=/go-cache
    container_name: productsvc
    environment:
      - GOCACHE=/go-cache
    env_file:
      - ./src/productservice/.env
    volumes: 
      - go-cache:/go-cache
    ports: 
      - "50051:50051"
    depends_on:
      - prometheus
      - jaeger

  envoy: 
    build: ./envoy 
    container_name: envoy
    ports: 
      - "8080:8080"
    depends_on:
      - productservice
    volumes:
      - ./envoy/descriptor.pb:/etc/envoy/descriptor.pb

  redis: 
    image: redis:alpine 
    container_name: shop-redis 
    ports: 
      - "6379:6379"
    volumes: 
      - redis-data:/data
    networks: 
      - shop-network
    command: ["redis-server", "--appendonly", "yes"]

networks:
  shop-network: 
    driver: bridge

volumes: 
  pgdata:
  go-cache:
  redis-data: